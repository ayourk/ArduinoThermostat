<!DOCTYPE html>
<html><head>
<title>Thermostat Config{if $HAS_ETHERNET == "1" && $HAS_WIFI == "1"} - Dual Network{elseif $HAS_WIFI == "1"} - WiFi{else} - Ethernet{/if}</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{background:#000;color:#eee;font-family:Arial,sans-serif;margin:0;padding:10px;display:flex;flex-direction:column;align-items:center}
.card{background:#111;border:1px solid #333;border-radius:6px;padding:10px;margin:8px 0;max-width:320px;width:100%}
.label{color:#999;font-size:.75em;font-weight:bold;margin-bottom:6px}
.row{display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:.9em}
.value{color:#4ade80;text-align:right}
input{background:#222;color:#eee;border:1px solid #555;border-radius:4px;padding:4px 6px;width:140px;font-size:.9em}
button{background:#333;color:#eee;border:1px solid #555;border-radius:4px;padding:6px 16px;margin:4px;cursor:pointer;font-size:.9em}
button:hover{background:#555}
.online{color:#4ade80}.offline{color:#f87171}.na{color:#999}
a{color:#60a5fa}
.net-border{border-color:#60a5fa}.net-label{color:#60a5fa}
.hint{color:#888;font-size:.75em}
.tabs{display:flex;border-bottom:1px solid #333;margin-bottom:8px}
.tab{flex:1;padding:8px;text-align:center;cursor:pointer;background:#1a1a1a;border:1px solid #333;border-bottom:none;margin-right:-1px;font-size:.85em;color:#888}
.tab:first-child{border-radius:4px 0 0 0}.tab:last-child{border-radius:0 4px 0 0;margin-right:0}
.tab.active{background:#111;color:#4ade80;border-bottom:1px solid #111;margin-bottom:-1px}
.tab-spacer{flex:1}
.info-box{background:#1a2a1a;border:1px solid #2a4a2a;border-radius:4px;padding:8px;margin:8px 0;font-size:.8em;color:#6b8}
.scan-btn{background:#1a3a5c;color:#60a5fa;border:1px solid #60a5fa;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:.78em;margin-left:6px}
.scan-btn:hover{background:#264a6e}.scan-btn:disabled{opacity:.5;cursor:wait}
.scan-list{background:#111;border:1px solid #444;border-radius:4px;margin:6px 0;max-height:160px;overflow-y:auto;font-size:.85em;display:none}
.scan-item{display:flex;justify-content:space-between;align-items:center;padding:5px 8px;cursor:pointer;border-bottom:1px solid #222}
.scan-item:last-child{border-bottom:none}.scan-item:hover{background:#1a2a3a}
.scan-ssid{color:#eee;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.scan-detail{color:#888;font-size:.85em;margin-left:8px;white-space:nowrap}
.scan-lock{color:#f87171;font-size:.7em;margin-left:4px}
.scan-bars{display:inline-block;margin-left:4px}
.scan-bar{display:inline-block;width:3px;background:#444;margin-right:1px;vertical-align:bottom;border-radius:1px 1px 0 0}
.scan-bar.active{background:#4ade80}
</style>
</head>
<body>

<!-- Network Configuration Card -->
<div class="card net-border">
<div class="label net-label">NETWORK CONFIGURATION</div>

<!-- Tab bar (always present) -->
<div class="tabs">
{if $HAS_ETHERNET == "1"}<div class="tab active" id="tabEth" onclick="switchTab('eth')">Ethernet</div>{else}<div class="tab-spacer"></div>{/if}
{if $HAS_WIFI == "1"}<div class="tab{if $HAS_ETHERNET != "1"} active{/if}" id="tabWifi" onclick="switchTab('wifi')">WiFi</div>{else}<div class="tab-spacer"></div>{/if}
</div>

<form id="netForm">

{if $HAS_ETHERNET == "1"}
<!-- Ethernet Panel -->
<div id="panelEth">
<div class="row"><span>IP</span><span class="value">{$ETH_IP}</span></div>
<div class="row"><span>MAC</span><span class="value">{$ETH_MAC}</span></div>
<div class="row"><span>Link</span><span class="value {if $ETH_CONNECTED == "1"}online{else}offline{/if}">{$ETH_LINK}</span></div>
<div class="hint" style="margin:8px 0 4px">Static IP (leave blank for DHCP)</div>
<div class="row"><span>Static IP</span><input id="eth_sip" value="{$ETH_CFG_IP}" placeholder="10.1.0.71"></div>
<div class="row"><span>DNS</span><input id="eth_dns" value="{$ETH_CFG_DNS}" placeholder="10.1.0.1"></div>
<div class="row"><span>Subnet</span><input id="eth_sub" value="{$ETH_CFG_SUBNET}" placeholder="255.255.255.0"></div>
<div class="row"><span>Gateway</span><input id="eth_gw" value="{$ETH_CFG_GATEWAY}" placeholder="10.1.0.1"></div>
</div>
{/if}

{if $HAS_WIFI == "1"}
<!-- WiFi Panel -->
<div id="panelWifi" {if $HAS_ETHERNET == "1"}style="display:none"{/if}>
<div class="row"><span>SSID</span><span class="value">{$WIFI_SSID}</span></div>
<div class="row"><span>IP</span><span class="value">{$WIFI_IP}</span></div>
<div class="row"><span>MAC</span><span class="value">{$WIFI_MAC}</span></div>
<div class="row"><span>RSSI</span><span class="value">{$WIFI_RSSI} dBm</span></div>
<div class="row"><span>SSID</span><span style="display:flex;align-items:center">
<input id="wifi_ssid" value="{$WIFI_CFG_SSID}" placeholder="MyNetwork">
<button type="button" class="scan-btn" id="scanBtn" onclick="doScan()">Scan</button></span></div>
<div class="scan-list" id="scanList"></div>
<div class="row"><span>Password</span><input id="wifi_pass" type="password" value="{$WIFI_CFG_PASS}"></div>
<div class="hint" style="margin:8px 0 4px">Static IP (leave blank for DHCP)</div>
<div class="row"><span>Static IP</span><input id="wifi_sip" value="{$WIFI_CFG_IP}" placeholder="192.168.1.50"></div>
<div class="row"><span>DNS</span><input id="wifi_dns" value="{$WIFI_CFG_DNS}" placeholder="192.168.1.1"></div>
<div class="row"><span>Subnet</span><input id="wifi_sub" value="{$WIFI_CFG_SUBNET}" placeholder="255.255.255.0"></div>
<div class="row"><span>Gateway</span><input id="wifi_gw" value="{$WIFI_CFG_GATEWAY}" placeholder="192.168.1.1"></div>
</div>
{/if}

<!-- Info box and Save -->
{if $HAS_ETHERNET == "1" && $HAS_WIFI == "1"}
<div class="info-box" id="infoBox">&#9432; Connected via Ethernet. WiFi changes apply immediately. Ethernet changes apply from WiFi or restart.</div>
{else}
<div class="info-box">&#9432; Changes apply after restart.</div>
{/if}
<div style="text-align:center;margin-top:8px">
<button type="submit" id="saveBtn">Save Network</button>
</div>
</form>

<!-- Board info -->
<div class="row" style="margin-top:8px;border-top:1px solid #333;padding-top:8px"><span>Board</span><span class="value">{$BOARD}</span></div>
<div class="row"><span>SD Card</span><span class="value">{if $SD_CARD == "1"}{$SD_FORMAT}{else}None{/if}</span></div>
</div>

<!-- Outdoor Unit Status -->
<div class="card"><div class="label">OUTDOOR UNIT STATUS</div>
<div class="row"><span>Outdoor IP</span><span class="value">{if $OUTDOOR_CONFIGURED == "1"}{$OUTDOOR_CFG_IP}{else}Not configured{/if}</span></div>
<div class="row"><span>Port</span><span class="value">{$OUTDOOR_CFG_PORT}</span></div>
<div class="row"><span>Poll interval</span><span class="value">{$OUTDOOR_POLL_SECS}s</span></div>
<div class="row"><span>Status</span><span class="value {if $OUTDOOR_AVAILABLE == "1"}online{elseif $OUTDOOR_STATUS == "Offline"}offline{else}na{/if}">{if $OUTDOOR_CONFIGURED == "1"}{$OUTDOOR_STATUS}{else}Not configured{/if}</span></div>
{if $OUTDOOR_AVAILABLE == "1"}
<div class="row"><span>Outdoor Temp</span><span class="value">{$OUTDOOR_TEMP}&deg;F</span></div>
{if $OUTDOOR_HUMIDITY != ""}<div class="row"><span>Humidity</span><span class="value">{$OUTDOOR_HUMIDITY}%</span></div>{/if}
{/if}
</div>

<!-- Configure Outdoor Unit -->
<div class="card"><div class="label">CONFIGURE OUTDOOR UNIT</div>
<form id="outForm" action="/config" method="get">
<div class="row"><span>Outdoor IP</span><input name="ip" value="{if $OUTDOOR_CONFIGURED == "1"}{$OUTDOOR_CFG_IP}{/if}" placeholder="10.1.0.72"></div>
<div class="row"><span>Port</span><input name="port" value="{$OUTDOOR_CFG_PORT}" placeholder="80"></div>
<div class="row"><span>Poll (sec)</span><input name="poll" value="{$OUTDOOR_POLL_SECS}" placeholder="30"></div>
<div style="text-align:center;margin-top:8px">
<button type="submit">Save</button>
</div>
</form>
{if $OUTDOOR_CONFIGURED == "1"}
<form id="clearForm" action="/config" method="get" style="text-align:center;margin-top:4px">
<input type="hidden" name="clear" value="1">
<button type="submit" style="color:#f87171">Clear Outdoor Config</button>
</form>
{/if}
</div>

<!-- Endpoints -->
<div class="card">
<div class="label">ENDPOINTS</div>
<div class="row"><a href="/">Home</a></div>
{if $SD_CARD == "1"}<div class="row"><a href="/sdfiles">/sdfiles</a> -- SD card file manager</div>{/if}
<div class="row"><a href="/outdoorjson">/outdoorjson</a> -- this unit as outdoor</div>
<div class="row"><a href="/indoorjson">/indoorjson</a> -- this unit as indoor</div>
<div class="row"><a href="/api/state">/api/state</a> -- JSON state</div>
<div class="row"><a href="/config">/config</a> -- this page</div>
{if $HAS_WIFI == "1"}<div class="row"><a href="/api/scan">/api/scan</a> -- WiFi scan (JSON)</div>{/if}
</div>

{if $SD_CARD != "1"}
<p style="color:#f87171;font-size:.8em;text-align:center">&#9888; No SD card -- settings won't persist across reboot.</p>
{/if}

<p><a href="/">&larr; Back to thermostat</a></p>

{literal}<script>
// Detect available interfaces from template variables
var hasEth = '{$HAS_ETHERNET}' === '1';
var hasWifi = '{$HAS_WIFI}' === '1';
var isDual = hasEth && hasWifi;

// Tab switching
function switchTab(t) {
  if (!isDual) return;
  var pe = document.getElementById('panelEth');
  var pw = document.getElementById('panelWifi');
  var te = document.getElementById('tabEth');
  var tw = document.getElementById('tabWifi');
  var ib = document.getElementById('infoBox');
  if (pe) pe.style.display = (t==='eth') ? 'block' : 'none';
  if (pw) pw.style.display = (t==='wifi') ? 'block' : 'none';
  if (te) te.classList.toggle('active', t==='eth');
  if (tw) tw.classList.toggle('active', t==='wifi');
  if (ib) ib.innerHTML = (t==='eth')
    ? '&#9432; Connected via Ethernet. WiFi changes apply immediately. Ethernet changes apply from WiFi or restart.'
    : '&#9432; Connected via WiFi. Ethernet changes apply immediately. WiFi changes apply from Ethernet or restart.';
}

// API POST helper
function apiPost(data, btn) {
  btn.disabled = true; btn.textContent = 'Saving...';
  fetch('/api/config', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)})
  .then(r => r.json()).then(j => {
    btn.textContent = j.success ? 'Saved!' : 'Error';
    setTimeout(() => location.reload(), 1500);
  }).catch(() => { btn.textContent = 'Error'; btn.disabled = false; });
}

// Network form submit â€” adapts action and keys to build type
document.getElementById('netForm').addEventListener('submit', function(e) {
  e.preventDefault();
  var d = {};
  if (isDual) {
    d.action = 'dual_network';
    d.eth_cfg_ip = document.getElementById('eth_sip').value;
    d.eth_cfg_dns = document.getElementById('eth_dns').value;
    d.eth_cfg_subnet = document.getElementById('eth_sub').value;
    d.eth_cfg_gateway = document.getElementById('eth_gw').value;
    d.wifi_ssid = document.getElementById('wifi_ssid').value;
    d.wifi_pass = document.getElementById('wifi_pass').value;
    d.wifi_cfg_ip = document.getElementById('wifi_sip').value;
    d.wifi_cfg_dns = document.getElementById('wifi_dns').value;
    d.wifi_cfg_subnet = document.getElementById('wifi_sub').value;
    d.wifi_cfg_gateway = document.getElementById('wifi_gw').value;
  } else if (hasWifi) {
    d.action = 'network';
    d.wifi_ssid = document.getElementById('wifi_ssid').value;
    d.wifi_pass = document.getElementById('wifi_pass').value;
    d.wifi_cfg_ip = document.getElementById('wifi_sip').value;
    d.wifi_cfg_dns = document.getElementById('wifi_dns').value;
    d.wifi_cfg_subnet = document.getElementById('wifi_sub').value;
    d.wifi_cfg_gateway = document.getElementById('wifi_gw').value;
  } else if (hasEth) {
    d.action = 'network';
    d.eth_cfg_ip = document.getElementById('eth_sip').value;
    d.eth_cfg_dns = document.getElementById('eth_dns').value;
    d.eth_cfg_subnet = document.getElementById('eth_sub').value;
    d.eth_cfg_gateway = document.getElementById('eth_gw').value;
  }
  apiPost(d, document.getElementById('saveBtn'));
});

// Outdoor form submit
document.getElementById('outForm').addEventListener('submit', function(e) {
  e.preventDefault();
  var f = e.target;
  apiPost({action:'outdoor', ip:f.ip.value, port:parseInt(f.port.value)||80, poll:parseInt(f.poll.value)||30}, f.querySelector('button[type=submit]'));
});

// Clear outdoor
document.getElementById('clearForm').addEventListener('submit', function(e) {
  e.preventDefault();
  apiPost({action:'clear_outdoor'}, e.target.querySelector('button[type=submit]'));
});

// WiFi scan (only available when hasWifi)
function doScan() {
  var btn = document.getElementById('scanBtn'), list = document.getElementById('scanList');
  btn.disabled = true; btn.textContent = 'Scanning...';
  list.style.display = 'block';
  list.innerHTML = '<div style="padding:10px;color:#888;text-align:center">Scanning...</div>';
  fetch('/api/scan').then(r => r.json()).then(data => {
    var nets = data.networks || data;
    nets.sort((a,b) => b.rssi - a.rssi);
    var h = '';
    for (var i = 0; i < nets.length; i++) {
      var n = nets[i];
      var lock = n.enc !== 'Open' ? '<span class="scan-lock" title="'+n.enc+'">&#128274;</span>' : '';
      var bars = '<span class="scan-bars">';
      var s = n.rssi >= -50 ? 4 : n.rssi >= -60 ? 3 : n.rssi >= -70 ? 2 : 1;
      for (var j = 1; j <= 4; j++) { bars += '<span class="scan-bar'+(j<=s?' active':'')+'\" style=\"height:'+(3+j*3)+'px\"></span>'; }
      bars += '</span>';
      h += '<div class="scan-item" onclick="selSsid(this.dataset.ssid)" data-ssid="'+n.ssid.replace(/"/g,'&quot;')+'">';
      h += '<span class="scan-ssid">'+n.ssid+lock+'</span>';
      h += '<span class="scan-detail">'+n.enc+' '+n.rssi+' dBm'+bars+'</span></div>';
    }
    if (data.count !== undefined && data.count >= data.maxNetworks) {
      h += '<div style="padding:6px;color:#888;text-align:center;font-size:11px">Showing top '+data.count+'</div>';
    }
    list.innerHTML = h || '<div style="padding:10px;color:#888;text-align:center">No networks found</div>';
    btn.disabled = false; btn.textContent = 'Scan';
  }).catch(() => {
    list.innerHTML = '<div style="padding:10px;color:#f87171;text-align:center">Scan failed</div>';
    btn.disabled = false; btn.textContent = 'Scan';
  });
}
function selSsid(s) { document.getElementById('wifi_ssid').value = s; }
</script>{/literal}
</body></html>
